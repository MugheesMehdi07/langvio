name: Release and Deploy

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.3.1)'
        required: true
        type: string
      test_deployment:
        description: 'Deploy to TestPyPI (uncheck for production PyPI)'
        required: false
        type: boolean
        default: true
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        type: boolean
        default: false

jobs:
  release-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.12"

    - name: Validate version format
      run: |
        VERSION="${{ github.event.inputs.version }}"
        echo "Received version: '$VERSION'"
        echo "Version length: ${#VERSION}"
        echo "Version type: $(type -t "$VERSION" 2>/dev/null || echo 'unknown')"
        
        # Check for empty or null version
        if [[ -z "$VERSION" ]]; then
          echo "âŒ Version is empty or null"
          exit 1
        fi
        
        # Check for whitespace issues
        VERSION_TRIMMED=$(echo "$VERSION" | xargs)
        if [[ "$VERSION" != "$VERSION_TRIMMED" ]]; then
          echo "âš ï¸  Version has leading/trailing whitespace, trimming..."
          VERSION="$VERSION_TRIMMED"
          echo "Trimmed version: '$VERSION'"
        fi
        
        # Simple validation first
        if [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
          echo "âœ… Basic semantic version format is valid: $VERSION"
        elif [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+[a-zA-Z0-9\-\.]*$ ]]; then
          echo "âœ… Extended semantic version format is valid: $VERSION"
        else
          echo "âŒ Invalid version format: '$VERSION'"
          echo "Expected format: X.Y.Z or X.Y.Z-prerelease (e.g., 1.0.0, 0.0.1, 1.0.0-beta.1)"
          exit 1
        fi

    - name: Update version in pyproject.toml
      run: |
        sed -i 's/version = "[^"]*"/version = "${{ github.event.inputs.version }}"/' pyproject.toml

    - name: Update version in __init__.py
      run: |
        sed -i 's/__version__ = "[^"]*"/__version__ = "${{ github.event.inputs.version }}"/' langvio/__init__.py

    - name: Generate changelog entry
      id: changelog
      run: |
        # Create a basic changelog entry
        echo "## Version ${{ github.event.inputs.version }}" > release_notes.md
        echo "" >> release_notes.md
        echo "### Changes" >> release_notes.md
        
        # Get commits since last tag
        LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
        if [ -n "$LAST_TAG" ]; then
          echo "Changes since $LAST_TAG:" >> release_notes.md
          git log --oneline $LAST_TAG..HEAD --grep="^feat\|^fix\|^docs\|^style\|^refactor\|^test\|^chore" >> release_notes.md
        else
          echo "Initial release" >> release_notes.md
        fi
        
        # Output for GitHub release
        echo "changelog<<EOF" >> $GITHUB_OUTPUT
        cat release_notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Commit version bump
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        echo "Git status before commit:"
        git status
        echo "Adding files..."
        git add pyproject.toml langvio/__init__.py
        echo "Git status after add:"
        git status
        echo "Committing changes..."
        git commit -m "Bump version to ${{ github.event.inputs.version }}" || exit 0
        echo "Creating tag..."
        git tag v${{ github.event.inputs.version }}
        echo "Git status after commit and tag:"
        git status

    - name: Push changes and tags
      run: |
        echo "Current branch: $(git branch --show-current)"
        echo "Available branches:"
        git branch -a
        echo "Remote configuration:"
        git remote -v
        echo "Current git status:"
        git status
        echo "Pushing to master branch..."
        git push origin master
        echo "Pushing tag v${{ github.event.inputs.version }}..."
        git push origin v${{ github.event.inputs.version }}

    - name: Create GitHub Release
      run: |
        gh release create v${{ github.event.inputs.version }} \
          --title "Release v${{ github.event.inputs.version }}" \
          --notes "${{ steps.changelog.outputs.changelog }}" \
          --draft=${{ github.event.inputs.prerelease }} \
          --prerelease=${{ github.event.inputs.prerelease }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine

    - name: Build package
      run: |
        python -m build

    - name: Publish to TestPyPI
      if: github.event.inputs.test_deployment == 'true'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.TEST_PYPI_API_TOKEN }}
        repository-url: https://test.pypi.org/legacy/
        skip-existing: true

    - name: Publish to Production PyPI
      if: github.event.inputs.test_deployment != 'true'
      uses: pypa/gh-action-pypi-publish@release/v1
      with:
        password: ${{ secrets.PYPI_API_TOKEN }}
        skip-existing: true

    - name: Deployment Summary
      run: |
        if [ "${{ github.event.inputs.test_deployment }}" = "true" ]; then
          echo "âœ… Package deployed to TestPyPI: https://test.pypi.org/project/langvio/"
          echo "ðŸ”— TestPyPI download: pip install --index-url https://test.pypi.org/simple/ langvio"
        else
          echo "ðŸš€ Package deployed to Production PyPI: https://pypi.org/project/langvio/"
          echo "ðŸ”— Production download: pip install langvio"
        fi